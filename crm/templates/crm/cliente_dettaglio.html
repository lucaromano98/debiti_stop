<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
        {% extends "crm/base.html" %}
    {% block content %}
    <h2>Cliente: {{ cliente.nome }} {{ cliente.cognome }}</h2>
    <p>
        <strong>Folder Cliente:</strong>
        clienti/{{ cliente.id }}_{{ cliente.nome|slugify }}-{{ cliente.cognome|slugify }}/
    </p>
    <p><strong>Email:</strong> {{ cliente.email|default:"—" }}</p>
    <p><strong>Telefono:</strong> {{ cliente.telefono|default:"—" }}</p>
    <p><strong>Stato:</strong> {{ cliente.get_stato_display }}</p>
    <p><a href="{% url 'cliente_modifica' cliente.id %}">✏️ Modifica</a> |
    <a href="{% url 'cliente_elimina' cliente.id %}">🗑️ Elimina</a></p>

    <hr />
        <h3>Documenti</h3>
        <p>
            <a href="{% url 'documento_nuovo' cliente.id %}">➕ Carica documento</a>
            |
            <a href="{% url 'documenti_zip_cliente' cliente.id %}">⬇️ Scarica tutti (ZIP)</a>
            </p>

        <div class="tabs" style="display:flex; gap:12px; margin-bottom:8px;">
            <button type="button" class="tab-btn" data-target="#tab-anag">Documenti anagrafici</button>
            <button type="button" class="tab-btn" data-target="#tab-prat">Pratiche</button>
            <button type="button" class="tab-btn" data-target="#tab-leg">Atti legali</button>
        </div>

            <h4> Tutti i documenti del cliente</h4>
            <ul>
            {% for d in cliente.documenti.all %}
                <li>
                ID {{ d.id }} — {{ d.get_categoria_display }} — {{ d.file.name }} — {{ d.caricato_il|date:"d/m/Y H:i" }}
                </li>
            {% empty %}
                <li>(nessun documento)</li>
            {% endfor %}
            </ul>



        <div id="tab-anag" class="tab-panel">
        <ul>
            {% for d in docs_anag %}
            <li>
                <a href="{{ d.file.url }}" target="_blank">{{ d.file.name|slice:'-40:' }}</a>
                — {{ d.descrizione|default:"(senza descrizione)" }}
                — {{ d.caricato_il|date:"d/m/Y H:i" }}
                — <a href="{% url 'documento_elimina' d.id %}">🗑️ Elimina</a>
            </li>
            {% empty %}
            <li>Nessun documento anagrafico.</li>
            {% endfor %}
        </ul>
        </div>

        <div id="tab-prat" class="tab-panel" style="display:none;">
        <ul>
            {% for d in docs_prat %}
            <li>
                <a href="{{ d.file.url }}" target="_blank">{{ d.file.name|slice:'-40:' }}</a>
                — {{ d.descrizione|default:"(senza descrizione)" }}
                — {{ d.caricato_il|date:"d/m/Y H:i" }}
                — <a href="{% url 'documento_elimina' d.id %}">🗑️ Elimina </a>
            </li>
            {% empty %}
            <li>Nessun documento di pratica.</li>
            {% endfor %}
        </ul>
        </div>

        <div id="tab-leg" class="tab-panel" style="display:none;">
        <ul>
            {% for d in docs_leg %}
            <li>
                <a href="{{ d.file.url }}" target="_blank">{{ d.file.name|slice:'-40:' }}</a>
                — {{ d.descrizione|default:"(senza descrizione)" }}
                — {{ d.caricato_il|date:"d/m/Y H:i" }}
                — <a href="{% url 'documento_elimina' d.id %}">🗑️ Elimina</a>
            </li>
            {% empty %}
            <li>Nessun atto legale.</li>
            {% endfor %}
        </ul>
        </div>
    <hr />
    <script>
        (function(){
            const btns = document.querySelectorAll('.tab-btn');
            const panels = document.querySelectorAll('.tab-panel');
            btns.forEach(btn => btn.addEventListener('click', () => {
            panels.forEach(p => p.style.display = 'none');
            document.querySelector(btn.dataset.target).style.display = 'block';
            }));
        })();
    </script>

    <h3>Pratiche</h3>
    <p><a href="{% url 'pratica_nuova' cliente.id %}">➕ Nuova pratica</a></p>
    <ul>
    {% for p in pratiche %}
        <li>
        <strong>{{ p.titolo|default:"(senza titolo)" }}</strong>
        — {{ p.importo|default:"—" }} — Attiva: {{ p.pratica_attiva|yesno:"Sì,No" }}
        — <a href="{% url 'pratica_modifica' p.id %}">✏️</a>
        — <a href="{% url 'pratica_elimina' p.id %}">🗑️</a>
        </li>
    {% empty %}
        <li>Nessuna pratica.</li>
    {% endfor %}
    </ul>

    
        <hr />
        <h3>Note</h3>

        <p><button id="openNotaModal">➕ Aggiungi nota</button></p>

       <ul>
            {% for n in note %}
                <li>
                <strong>{{ n.autore_nome }}</strong> — {{ n.creata_il|date:"d/m/Y H:i" }}<br/>
                {{ n.testo|linebreaksbr }}<br/>
                <a href="{% url 'nota_modifica' n.id %}">✏️ Modifica</a>
                •
                <a href="{% url 'nota_elimina' n.id %}">🗑️ Elimina</a>
                </li>
            {% empty %}
                <li>Nessuna nota.</li>
            {% endfor %}
        </ul>


        <!-- MODAL: aggiungi nota -->
        <div id="notaModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);">
        <div style="background:#fff; max-width:520px; margin:10% auto; padding:16px; border-radius:8px; position:relative;">
            <h4>Nuova nota</h4>
            <form method="post" action="{% url 'nota_crea' cliente.id %}">
            {% csrf_token %}
            <p>
                <label for="id_autore_nome">Nome</label><br/>
                {{ nota_form.autore_nome }}
            </p>
            <p>
                <label for="id_testo">Nota</label><br/>
                {{ nota_form.testo }}
            </p>
            <div style="margin-top:8px;">
                <button type="submit">Salva</button>
                <button type="button" id="closeNotaModal">Annulla</button>
            </div>
            </form>
        </div>
        </div>

        <script>
        (function(){
            const openBtn = document.getElementById('openNotaModal');
            const closeBtn = document.getElementById('closeNotaModal');
            const modal = document.getElementById('notaModal');
            if(openBtn && modal){
            openBtn.addEventListener('click', function(){ modal.style.display = 'block'; });
            }
            if(closeBtn && modal){
            closeBtn.addEventListener('click', function(){ modal.style.display = 'none'; });
            }
            // chiudi cliccando sullo sfondo scuro
            if(modal){
            modal.addEventListener('click', function(e){
                if(e.target === modal){ modal.style.display = 'none'; }
            });
            }
        })();
        </script>



    <p><a href="{% url 'clienti_tutti' %}">⬅️ Torna alla lista</a></p>
    {% endblock %}
</body>
</html>