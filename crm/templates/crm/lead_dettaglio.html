{% extends "crm/base.html" %}
{% block title %}{{ lead.nome }} {{ lead.cognome }} · Lead{% endblock %}

{% block content %}
<div class="mx-auto max-w-[min(1400px,100%)] space-y-6">

  <!-- HEADER -->
  <div class="card bg-base-100 shadow">
    <div class="card-body gap-4">
      <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
          <h1 class="text-2xl font-extrabold tracking-tight">
            {{ lead.nome }} {{ lead.cognome }}
            {% if lead.stato == 'positivo' %}
              <span class="badge badge-success badge-outline align-middle ml-2">Positivo</span>
            {% elif lead.stato == 'negativo' %}
              <span class="badge badge-error badge-outline align-middle ml-2">Negativo</span>
            {% else %}
              <span class="badge badge-info badge-outline align-middle ml-2">In corso</span>
            {% endif %}
          </h1>

          <div class="mt-2 grid gap-x-8 gap-y-1 sm:grid-cols-2 lg:grid-cols-3 text-sm">
            <div><span class="font-semibold">Email:</span> {{ lead.email|default:"—" }}</div>
            <div><span class="font-semibold">Telefono:</span> {{ lead.telefono|default:"—" }}</div>
            <div><span class="font-semibold">Provenienza:</span> {{ lead.get_provenienza_display|default:"—" }}</div>
            <div><span class="font-semibold">Consulente:</span> {{ lead.consulente|default:"—" }}</div>
            <div><span class="font-semibold">Creato:</span> {{ lead.creato_il|date:"d/m/Y H:i" }}</div>
            <div><span class="font-semibold">Primo contatto:</span> {% if lead.primo_contatto %}{{ lead.primo_contatto|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
            <div><span class="font-semibold">Appuntamento previsto:</span> {% if lead.appuntamento_previsto %}{{ lead.appuntamento_previsto|date:"d/m/Y H:i" }}{% else %}—{% endif %}</div>
            <div><span class="font-semibold">Richiamare il:</span> {% if lead.richiamare_il %}{{ lead.richiamare_il|date:"d/m/Y" }}{% else %}—{% endif %}</div>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <a href="{% url 'lead_modifica' lead.id %}" class="btn btn-ghost">✏️ Modifica</a>
          <a href="{% url 'lead_lista' %}" class="btn">⬅️ Torna alla lista</a>
        </div>
      </div>
    </div>
  </div>

  <!-- AZIONI RAPIDE -->
<!-- AZIONI RAPIDE -->
<div class="card bg-base-100 shadow">
  <div class="card-body gap-4">

    <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
      <div>
        <div class="text-xs opacity-60 mb-1">Stato lavorazione attuale</div>

        {% if lead.stato_operativo == 'consulenza_eff' %}
          <span class="badge badge-success badge-outline">Consulenza effettuata</span>
        {% elif lead.stato_operativo == 'no_risposta' %}
          <span class="badge badge-warning badge-outline">Senza risposta</span>
        {% elif lead.stato_operativo == 'msg_inviato' %}
          <span class="badge badge-info badge-outline">Messaggio inviato</span>
        {% elif lead.stato_operativo == 'in_acquisizione' %}
          <span class="badge badge-primary badge-outline">In acquisizione</span>
        {% elif lead.stato_operativo == 'non_competenza' %}
          <span class="badge badge-neutral badge-outline">Attività non di competenza</span>
        {% elif lead.stato_operativo == 'attesa_contatti' %}
          <span class="badge badge-accent badge-outline">Attesa contatti cliente</span>
        {% else %}
          <span class="badge badge-ghost">Nuovo</span>
        {% endif %}
      </div>

      <form method="post" action="{% url 'lead_aggiorna_stato_operativo' lead.id %}" class="flex flex-wrap items-end gap-2">
        {% csrf_token %}
        <div class="form-control min-w-[280px]">
          <label class="label py-0 mb-1">
            <span class="label-text text-xs opacity-70">Aggiorna stato</span>
          </label>
          <select name="stato_operativo" class="select select-bordered select-sm">
            {% for val, label in STATI_OPERATIVI %}
              <option value="{{ val }}" {% if lead.stato_operativo == val %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>
        <button class="btn btn-primary btn-sm" type="submit">Salva stato</button>
      </form>
    </div>

    {% if lead.motivazione_negativa %}
      <div class="alert alert-warning mt-1">
        <span class="font-semibold">Motivazione esito negativo:</span>
        <span class="ml-1">{{ lead.motivazione_negativa }}</span>
      </div>
    {% endif %}

    {% if lead.note_operatori %}
      <div class="mt-1">
        <div class="text-xs opacity-60">Note operatori</div>
        <p class="whitespace-pre-line mt-1">{{ lead.note_operatori }}</p>
      </div>
    {% endif %}

  </div>
</div>

  <!-- SCHEDE DI CONSULENZA -->
  <section>
    <div class="card bg-base-100 shadow">
      <div class="card-body gap-4">
        <div class="flex items-center justify-between">
          <h2 class="card-title">Schede di consulenza</h2>
          <a href="{% url 'scheda_consulenza_nuova_lead' lead.id %}" class="btn btn-primary btn-sm">
            Compila scheda
          </a>
        </div>

        {% if schede_consulenza %}
          <ul class="space-y-2">
            {% for s in schede_consulenza %}
              <li class="rounded-lg border border-base-300/60 px-3 py-2">
                <div class="flex items-center justify-between gap-3">
                  <a href="{% url 'scheda_consulenza_dettaglio' s.id %}" class="font-medium hover:underline">
                    Compilata da {{ s.compilata_da|default:"—" }} — {{ s.created_at|date:"d/m/Y H:i" }}
                  </a>
                  <div class="flex items-center gap-2">
                    <a href="{% url 'scheda_consulenza_dettaglio' s.id %}" class="btn btn-ghost btn-xs">Apri</a>
                    <a href="{% url 'scheda_consulenza_modifica' s.id %}" class="btn btn-outline btn-xs">Modifica</a>
                    {% if request.user.is_superuser or request.user.profiloutente and request.user.profiloutente.ruolo == 'admin' %}
                    <form method="post" action="{% url 'scheda_consulenza_elimina' s.id %}"
                          onsubmit="return confirm('Eliminare definitivamente questa scheda?');">
                      {% csrf_token %}
                      <button class="btn btn-outline btn-error btn-xs" type="submit">Elimina</button>
                    </form>
                    {% endif %}
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-sm opacity-70">Nessuna scheda compilata.</div>
        {% endif %}
      </div>
    </div>
  </section>

</div>
{% endblock %}
