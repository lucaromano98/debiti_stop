
{% extends "crm/base.html" %}
{% load qparams %}

{% block title %}Tutti i lead · Debiti Stop{% endblock %}

{% block content %}

<style>
  /* Badge stati lavorazione - ottimizzati per tabella dark */
.badge-work {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  border-radius: 9999px;
  padding: 0.22rem 0.55rem;
  font-size: 0.72rem;
  line-height: 1rem;
  font-weight: 700;
  white-space: nowrap;
  border: 1px solid transparent;
}

.badge-work::before {
  content: "";
  width: 0.42rem;
  height: 0.42rem;
  border-radius: 9999px;
  background: currentColor;
  opacity: 0.95;
}

/* Nuovo */
.badge-work-nuovo {
  background: #334155;      /* slate-700 */
  color: #f1f5f9;           /* slate-100 */
  border-color: #475569;
}

/* Messaggio inviato */
.badge-work-msg {
  background: #075985;      /* sky-800 */
  color: #e0f2fe;           /* sky-100 */
  border-color: #0ea5e9;    /* sky-500 */
}

/* Senza risposta */
.badge-work-no-risposta {
  background: #92400e;      /* amber-800 */
  color: #fef3c7;           /* amber-100 */
  border-color: #f59e0b;    /* amber-500 */
}

/* Consulenza effettuata */
.badge-work-consulenza {
  background: #166534;      /* green-800 */
  color: #dcfce7;           /* green-100 */
  border-color: #22c55e;    /* green-500 */
}

/* In acquisizione */
.badge-work-acquisizione {
  background: #3730a3;      /* indigo-800 */
  color: #e0e7ff;           /* indigo-100 */
  border-color: #6366f1;    /* indigo-500 */
}

/* Attività non di competenza */
.badge-work-non-competenza {
  background: #991b1b;      /* red-800 */
  color: #fee2e2;           /* red-100 */
  border-color: #ef4444;    /* red-500 */
}

/* Attesa contatti cliente */
.badge-work-attesa {
  background: #6b21a8;      /* purple-800 */
  color: #f3e8ff;           /* purple-100 */
  border-color: #a855f7;    /* purple-500 */
}
</style>



<div class="mx-auto max-w-[min(1400px,100%)] space-y-5">

  <!-- Header -->
  <div class="flex items-center justify-between">
    <h1 class="text-xl font-extrabold">Tutti i lead</h1>
    <div class="flex gap-2">
      {# opzionale: export, se hai la view lead_export #}
      {# <a class="btn btn-outline" href="{% url 'lead_export' %}?{{ request.GET.urlencode }}">⬇︎ Esporta CSV</a> #}
      <a class="btn btn-primary" href="{% url 'lead_nuovo' %}">+ Nuovo lead</a>
    </div>
  </div>

  <!-- Filtri -->
  <form method="get" class="card bg-base-100 shadow">
    <div class="card-body gap-4">
      <div class="grid gap-3 md:grid-cols-4">
        <label class="form-control md:col-span-2">
          <div class="label"><span class="label-text">Cerca (nome, email, telefono)</span></div>
          <input type="text" name="q" value="{{ q }}" class="input input-bordered w-full" />
        </label>

        <label class="form-control">
          <div class="label"><span class="label-text">Stato</span></div>
          <select name="stato" class="select select-bordered w-full">
            <option value="">Tutti</option>
            <option value="in_corso" {% if stato == 'in_corso' %}selected{% endif %}>In corso</option>
            <option value="negativo" {% if stato == 'negativo' %}selected{% endif %}>Negativo</option>
            <option value="positivo" {% if stato == 'positivo' %}selected{% endif %}>Positivo</option>
          </select>
        </label>

        <div class="grid grid-cols-2 gap-3">
          <label class="form-control">
            <div class="label"><span class="label-text">Primo Contatto</span></div>
            <input type="date" name="primo_contatto" value="{{ primo_contatto }}" class="input input-bordered w-full" />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Appuntamento</span></div>
            <input type="date" name="appuntamento" value="{{ appuntamento }}" class="input input-bordered w-full" />
          </label>
        </div>

      </div>

      {# --- FILTRI: PROVENIENZA + CONSULENTE + STATO LAVORAZIONE --- #}
      <div class="grid gap-3 md:grid-cols-4">
        <label class="form-control">
          <div class="label"><span class="label-text">Provenienza</span></div>
          <select name="provenienza" class="select select-bordered w-full">
            <option value="">Tutte</option>
            {% for val,label in PROVENIENZA_CHOICES %}
              <option value="{{ val }}" {% if provenienza == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </label>

        <label class="form-control">
          <div class="label"><span class="label-text">Consulente</span></div>
          <select name="consulente" class="select select-bordered w-full">
            <option value="">Tutti</option>
            {% for c in consulenti %}
              <option value="{{ c.id }}" {% if consulente_sel == c.id|stringformat:"s" %}selected{% endif %}>
                {{ c.nome }}
              </option>
            {% endfor %}
          </select>
        </label>

        <label class="form-control">
          <div class="label"><span class="label-text">Stato lavorazione</span></div>
          <select name="stato_operativo" class="select select-bordered w-full">
            <option value="">Tutti</option>
            {% for val,label in STATI_OPERATIVI %}
              <option value="{{ val }}" {% if stato_operativo == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </label>

        <label class="form-control">
          <div class="label"><span class="label-text">Creditore legale</span></div>
          <select name="creditore_legale" class="select select-bordered w-full">
            <option value="">Tutti</option>
            {% for val,label in CREDITORI_LEGALI %}
              <option value="{{ val }}" {% if creditore_legale == val %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </label>

      </div>

      <!-- Quick filter appuntamenti -->
      <div class="card bg-base-200/40">
        <div class="card-body gap-2">
          <div class="label"><span class="label-text font-semibold">Appuntamenti</span></div>
          <div class="flex flex-wrap items-center gap-2">
            <label class="btn btn-sm {% if not appt %}btn-active{% endif %}">
              <input type="radio" name="appt" value="" class="hidden" {% if not appt %}checked{% endif %}>
              Tutti
            </label>
            <label class="btn btn-sm {% if appt == 'today' %}btn-active{% endif %}">
              <input type="radio" name="appt" value="today" class="hidden" {% if appt == 'today' %}checked{% endif %}>
              Oggi
            </label>
            <label class="btn btn-sm {% if appt == 'tomorrow' %}btn-active{% endif %}">
              <input type="radio" name="appt" value="tomorrow" class="hidden" {% if appt == 'tomorrow' %}checked{% endif %}>
              Domani
            </label>
            <label class="btn btn-sm {% if appt == 'next3' %}btn-active{% endif %}">
              <input type="radio" name="appt" value="next3" class="hidden" {% if appt == 'next3' %}checked{% endif %}>
              Prossimi 3 giorni
            </label>
            <label class="btn btn-sm {% if appt == 'next7' %}btn-active{% endif %}">
              <input type="radio" name="appt" value="next7" class="hidden" {% if appt == 'next7' %}checked{% endif %}>
              Prossimi 7 giorni
            </label>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 justify-end">
        <button type="submit" class="btn btn-primary">Filtra</button>
        <a class="btn btn-ghost" href="{% url 'lead_lista' %}">Reset</a>
      </div>
    </div>
  </form>

  <!-- Tabella -->
  <div class="table-shell">
    <div class="table-scroll">
      <table class="table table-zebra table-app">
        <thead>
          <tr>
            <th class="th-min">#</th>
            <th>
              <a href="{% qurl sort='nome' page=None %}" class="link link-hover">Nome</a>
              <span class="sort-raw">▲▼</span>
            </th>
            <th>
              <a href="{% qurl sort='cognome' page=None %}" class="link link-hover">Cognome</a>
              <span class="sort-raw">▲▼</span>
            </th>
            <th>Lavorazione</th>
            <th>Creditore Legale</th>
            <th>Email</th>
            <th>Telefono</th>
            <th>
              <a href="{% qurl sort='provenienza' page=None %}" class="link link-hover">Provenienza</a>
              <span class="sort-raw">▲▼</span>
            </th>
            <th>
              <a href="{% qurl sort='consulente' page=None %}" class="link link-hover">Consulente</a>
              <span class="sort-raw">▲▼</span>
            </th>
            <th>
              <a href="{% qurl sort='primo_contatto' page=None %}" class="link link-hover">Primo contatto</a>
              <span class="sort-raw">▲▼</span>
            </th>
            <th>
              <a href="{% qurl sort='creato_il' page=None %}" class="link link-hover">Creato</a>
              <span class="sort-raw">▲▼</span>
            </th>
            <th>
              <a href="{% qurl sort='appuntamento_previsto' page=None %}" class="link link-hover">
                Appuntamento previsto il
              </a>
              <span class="sort-raw">▲▼</span>
            </th>
            <th>
              <a href="{% qurl sort='richiamare_il' page=None %}" class="link link-hover">Richiamare il</a>
              <span class="sort-raw">▲▼</span>
            </th>
            <th>Stato</th>
            <th class="th-min td-actions">Azioni</th>
          </tr>
        </thead>
        <tbody>
          {% for l in leads %}
          <tr class="lead-row cursor-pointer"
              data-detail-url="{% url 'lead_dettaglio' l.pk %}">
            <td class="td-nowrap">{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td class="td-nowrap">{{ l.nome }}</td>
            <td class="td-nowrap">{{ l.cognome }}</td>

            <!-- Stato lavorazione (subito dopo nome/cognome) -->
            <td class="td-nowrap">
              {% if l.stato_operativo == 'consulenza_eff' %}
                <span class="badge-work badge-work-consulenza">Consulenza effettuata</span>
              {% elif l.stato_operativo == 'no_risposta' %}
                <span class="badge-work badge-work-no-risposta">Senza risposta</span>
              {% elif l.stato_operativo == 'msg_inviato' %}
                <span class="badge-work badge-work-msg">Messaggio inviato</span>
              {% elif l.stato_operativo == 'in_acquisizione' %}
                <span class="badge-work badge-work-acquisizione">In acquisizione</span>
              {% elif l.stato_operativo == 'non_competenza' %}
                <span class="badge-work badge-work-non-competenza">Non di competenza</span>
              {% elif l.stato_operativo == 'attesa_contatti' %}
                <span class="badge-work badge-work-attesa">Attesa contatti</span>
              {% else %}
                <span class="badge-work badge-work-nuovo">Nuovo</span>
              {% endif %}
            </td>

            <td class="td-nowrap">
              {% if l.creditore_legale == "altro" and l.creditore_legale_altro %}
                {{ l.creditore_legale_altro }}
              {% else %}
                {{ l.get_creditore_legale_display|default:"—" }}
              {% endif %}
            </td>

            <td class="td-nowrap">{{ l.email|default:"—" }}</td>
            <td class="td-nowrap">{{ l.telefono|default:"—" }}</td>
            <td class="td-nowrap">
              {{ l.get_provenienza_display|default:"—" }}
            </td>
            <td class="td-nowrap">{{ l.consulente|default:"—" }}</td>
            <td class="td-nowrap">
              {% if l.primo_contatto %}{{ l.primo_contatto|date:"d/m/Y H:i" }}{% else %}—{% endif %}
            </td>
            <td class="td-nowrap">{{ l.creato_il|date:"d/m/Y H:i" }}</td>
            <td class="td-nowrap">
              {% if l.appuntamento_previsto %}
                {{ l.appuntamento_previsto|date:"d/m/Y H:i" }}
              {% else %}—{% endif %}
            </td>
            <td class="td-nowrap">
              {% if l.richiamare_il %}{{ l.richiamare_il|date:"d/m/Y" }}{% else %}—{% endif %}
            </td>
            <td class="td-nowrap">
              {% if l.stato == 'positivo' %}
                <span class="badge-attivo">Positivo</span>
              {% elif l.stato == 'negativo' %}
                <span class="badge-negativo">Negativo</span>
              {% else %}
                <span class="badge-in-corso">In corso</span>
              {% endif %}
            </td>
            <td class="td-actions">
              <div class="join">
                <a href="{% url 'lead_dettaglio' l.pk %}" class="btn btn-ghost btn-sm join-item">Apri</a>
                <a href="{% url 'lead_modifica' l.pk %}" class="btn btn-outline btn-sm join-item">Modifica</a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="14" class="text-center text-base-content/60 py-6">Nessun lead trovato.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginazione -->
    <div class="pager">
      <div class="text-sm opacity-70">
        Pagina {{ page_obj.number }} di {{ page_obj.paginator.num_pages }}
      </div>
      <div class="join">
        <a class="btn join-item" href="{% qurl page=1 %}" {% if not page_obj.has_previous %}disabled{% endif %}>«</a>
        <a class="btn join-item" href="{% if page_obj.has_previous %}{% qurl page=page_obj.previous_page_number %}{% endif %}" {% if not page_obj.has_previous %}disabled{% endif %}>Prec</a>
        <a class="btn join-item" href="{% if page_obj.has_next %}{% qurl page=page_obj.next_page_number %}{% endif %}" {% if not page_obj.has_next %}disabled{% endif %}>Succ</a>
        <a class="btn join-item" href="{% qurl page=page_obj.paginator.num_pages %}" {% if not page_obj.has_next %}disabled{% endif %}>»</a>
      </div>
    </div>
  </div>

  {% if ha_negativi %}
    <div class="alert alert-warning mt-2">
      <span>Ci sono lead con esito <b>negativo</b> nei risultati.</span>
    </div>
  {% endif %}

</div>

<!-- Auto-submit per quick appt & select nuovi -->
<script>
  document.querySelectorAll('input[name="appt"]').forEach(r => {
    r.addEventListener('change', () => r.form && r.form.submit());
  });

 document.querySelectorAll('select[name="provenienza"], select[name="consulente"], select[name="creditore_legale"]').forEach(s => {
  s.addEventListener('change', () => s.form && s.form.submit());
});

  document.querySelectorAll('.lead-row').forEach(row => {
    row.addEventListener('dblclick', (e) => {
      // Non scattare se il doppio click è su elementi interattivi
      if (e.target.closest('a, button, input, select, textarea, form')) return;

      const url = row.dataset.detailUrl;
      if (url) window.location.href = url;
    });
  });
</script>
{% endblock %}